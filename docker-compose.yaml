services:
  mongodb:
    image: mongo:8.0.0
    ports:
      - "27017:27017"
    volumes:
      - mongo_storage:/volumes/mongodb:/data/db

  redis:
    image: redis:latest
    ports:
      - "6379:6379"
    volumes:
      - redis_storage:/volumes/redis:/data

  rabbit:
    image: rabbitmq:4-management
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-admin}

  influxdb:
    image: influxdb:latest
    container_name: influxdb
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb
    environment:
      - INFLUXD_BUCKET=${INFLUXD_BUCKET:-jti-bucket}
      - INFLUXD_ORG=${INFLUXD_ORG:-jti-org}
      - INFLUXD_USERNAME=${INFLUXD_USERNAME:-admin}
      - INFLUXD_PASSWORD=${INFLUXD_PASSWORD:-admin}
      - INFLUXD_RETENTION=${INFLUXD_RETENTION:-0}
      - INFLUXD_ADMIN_TOKEN=${INFLUXD_ADMIN_TOKEN:-my-super-secret-token}
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin123
      - DOCKER_INFLUXDB_INIT_ORG=jti-org
      - DOCKER_INFLUXDB_INIT_BUCKET=jti-bucket
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=my-super-secret-token

  telegraf:
    image: telegraf:latest
    container_name: telegraf
    depends_on:
      - influxdb
      - rabbit
      # Need to wait for the JTI application to start
    restart: on-failure
    environment:
      - RABBITMQ_USER=${RABBITMQ_USER:-admin}
      - RABBITMQ_PASS=${RABBITMQ_PASS:-admin}
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-task-events}
      - INFLUX_TOKEN=${INFLUX_TOKEN:-my-super-secret-token}
      - INFLUX_URL=${INFLUX_URL:-http://influxdb:8086}
      - INFLUX_ORG=${INFLUX_ORG:-jti-org}
      - INFLUX_BUCKET=${INFLUX_BUCKET:-jti-bucket}
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro

  grafana:
    image: grafana/grafana
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - INFLUXD_ORG=${INFLUXD_ORG:-jti-org}
      - INFLUXD_BUCKET=${INFLUXD_BUCKET:-jti-bucket}
      - INFLUXD_ADMIN_TOKEN=${INFLUXD_ADMIN_TOKEN:-my-super-secret-token}
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
      - GF_INSTALL_PLUGINS=grafana-influxdb-flux-datasource
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD:-admin}
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER:-admin}
    volumes:
      - grafana_storage:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboard:/etc/grafana/dashboards

  just-task-it:
    build:
      context: .

    # Specifies the name and tag of the image that Docker should build or pull.
    image: 2dv013/just-task-it:1.0.0

    # Specifies that the 'just-task-it' service depends on the 'mongodb' service.
    # This means that Docker will start the 'mongodb' service before the 'just-task-it' service.
    depends_on:
      - mongodb
      - rabbit

    # Specifies that Docker should restart the 'just-task-it' service if it fails.
    restart: on-failure

    # The 'environment' directive is used to set environment variables in the Docker container.
    # These variables can be accessed by the application running inside the container.
    # Each line under this directive sets a different environment variable.
    # ---------------------------------------------------------------------------------------------------------
    # ðŸ‘‰ DOCKER_HOST_PORT and SESSION_SECRET must be set in the host environment before running 'docker compose up'.
    # ---------------------------------------------------------------------------------------------------------
    environment:
      # The base URL for the application. Defaults to '/' if not provided.
      - BASE_URL=${BASE_URL:-/}

      # The connection string for the MongoDB database. Defaults to 'mongodb://mongodb:27017/just-task-it' if not provided.
      - DB_CONNECTION_STRING=${DB_CONNECTION_STRING:-mongodb://mongodb:27017/just-task-it}

      # The RabbitMQ connection URL. Defaults to 'amqp://admin:admin@rabbit:5672' if not provided.
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://admin:admin@rabbit:5672}

      # The port that the Express application listens on. Defaults to 3000 if not provided.
      - PORT=${EXPRESS_APP_PORT:-3000}

      # The name of the session. Defaults to 'just-task-it-feat-logging.user-session' if not provided.
      - SESSION_NAME=${SESSION_NAME:-just-task-it-feat-logging.user-session}

      # The secret used to sign the session ID cookie. No default value.
      - SESSION_SECRET=${SESSION_SECRET}

      # The level of logging. Defaults to 'http' if not provided.
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Whether to add remote address information to the logs. Defaults to 'true' if not provided.
      - LOGGER_MORGAN_FORMAT_ADD_REMOTE=${LOGGER_MORGAN_FORMAT_ADD_REMOTE:-true}

      # The file to write combined logs to. Defaults to '/var/log/just-task-it/combined.log' if not provided.
      - LOGGER_COMBINED_LOG_FILE=${LOGGER_COMBINED_LOG_FILE:-/var/log/just-task-it/combined.log}

      # The file to write error logs to. Defaults to '/var/log/just-task-it/error.log' if not provided.
      - LOGGER_ERROR_LOG_FILE=${LOGGER_ERROR_LOG_FILE:-/var/log/just-task-it/error.log}

      # The file to write uncaught exception logs to. Defaults to '/var/log/just-task-it/uncaught-exception.log' if not provided.
      - LOGGER_UNCAUGHT_EXCEPTION_LOG_FILE=${LOGGER_UNCAUGHT_EXCEPTION_LOG_FILE:-/var/log/just-task-it/uncaught-exception.log}

    # ---------------------------------------------------------------------------------------------------------
    # NOTE! The subsequent environment variables are utilized by the logger for logging to a database.
    #       If these are not set, the logger will not log to MongoDB. Maybe something to consier for production?
    #

    # The MongoDB connection string to use for the logger. Defaults to 'mongodb://mongodb:27017/just-task-it-audit'.
    # - LOGGER_DB_CONNECTION_STRING=${LOGGER_DB_CONNECTION_STRING:-mongodb://mongodb:27017/just-task-it-audit}

    # The name of the collection to use for the logger. Defaults to 'logs'.
    # - LOGGER_DB_COLLECTION_NAME=${LOGGER_DB_COLLECTION_NAME:-logs}

    #
    # ---------------------------------------------------------------------------------------------------------

    # The 'ports' directive maps the port inside the Docker container to a port on the host machine.
    ports:
      # Maps the DOCKER_HOST_PORT environment variable on the host to the EXPRESS_APP_PORT inside the 'just-task-it' container.
      # This allows external access to the 'just-task-it' service on the specified host port.
      - "${DOCKER_HOST_PORT}:${EXPRESS_APP_PORT:-3000}"

volumes:
  influxdb_data:
  grafana_storage:
  mongo_storage:
  redis_storage:
