name: Terraform Bootstrap

on:
    workflow_dispatch:

jobs:
    bootstrap:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_CREDENTIALS }}

            - name: Set up ENV Variables
              env:
                  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
                  GCP_REGION: ${{ vars.GCP_REGION }}
                  GCP_PROJECT_NAME: ${{ vars.GCP_PROJECT_NAME }}
                  DEVOPS_SA_EMAIL: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
              run: |
                  echo "TF_VAR_project_id=${GCP_PROJECT_ID}" >> $GITHUB_ENV
                  echo "TF_VAR_region=${GCP_REGION}" >> $GITHUB_ENV
                  echo "TF_VAR_project_name=${GCP_PROJECT_NAME}" >> $GITHUB_ENV
                  echo "TF_VAR_devops_service_account_email=${DEVOPS_SA_EMAIL}" >> $GITHUB_ENV

            - name: Terraform init
              run: terraform init
              working-directory: infra/terraform/bootstrap

            - name: Terraform plan
              run: terraform plan -out=tfplan -var-file=env.tfvars
              working-directory: infra/terraform/bootstrap

            - name: Terraform apply
              run: terraform apply -auto-approve tfplan
              working-directory: infra/terraform/bootstrap

            - name: Capture outputs
              run: |
                  echo "=== Bootstrap Complete ==="
                  terraform output
              working-directory: infra/terraform/bootstrap

            - name: Update GCP_BUCKET_NAME variable
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  BUCKET_NAME=$(terraform output -raw tfstate_bucket)
                  gh variable set GCP_BUCKET_NAME --body "$BUCKET_NAME"
              working-directory: infra/terraform/bootstrap
